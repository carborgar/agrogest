{% extends "base.html" %}
{% load django_bootstrap5 %}

{% block header %}{{ form.instance.pk|yesno:"Editar,Nuevo" }} gasto{% endblock %}

{% block extra_head %}
<style>
    .option-icon {
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }

    .option-card {
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }

    .option-card:hover {
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .option-card.selected {
        border-color: var(--bs-primary) !important;
        border-width: 2px !important;
        box-shadow: 0 0 0 0.2rem rgba(var(--bs-primary-rgb), 0.25);
    }

    .option-card.selected::before {
        content: '✓';
        position: absolute;
        top: 8px;
        right: 8px;
        background: var(--bs-primary);
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: bold;
    }

    .cursor-pointer {
        cursor: pointer;
    }

    @media (max-width: 768px) {
        .option-card {
            margin-bottom: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card shadow-sm border-0 rounded-lg">
            <div class="card-header bg-primary text-white py-3">
                <h2 class="mb-0 fs-3">{{ form.instance.pk|yesno:"Editar,Añadir" }} gasto</h2>
            </div>
            <div class="card-body p-4">
                <form id="expenseForm" method="post">
                    {% csrf_token %}

                    <!-- Información básica -->
                    <div class="row mb-4">
                        {% bootstrap_field form.field wrapper_class="col-md-4 mb-2" label_class="required" %}
                        {% bootstrap_field form.expense_type wrapper_class="col-md-4 mb-2" label_class="required" %}
                        {% bootstrap_field form.payment_date wrapper_class="col-md-4 mb-2" label_class="required" %}
                        {% bootstrap_field form.description wrapper_class="col-md-12" %}
                    </div>

                    <!-- Campo oculto para calculation_mode -->
                    <input id="id_calculation_mode" name="calculation_mode" type="hidden"
                           value="{{ form.calculation_mode.value|default:'total' }}">

                    <div class="mb-4">
                        <h5 class="mb-3 text-dark">¿Cómo quieres calcular el importe?</h5>
                        <div class="row g-3 justify-content-center text-center">

                            <!-- Opción 1: Importe directo -->
                            <div class="col-md-4">
                                <div class="calculation-option" data-mode="total">
                                    <div class="option-card h-100 border rounded-3 p-3 cursor-pointer">
                                        <div class="row align-items-center">
                                            <div class="col-4 col-md-12 text-center text-md-center">
                                                <div class="option-icon bg-primary bg-opacity-10 text-primary rounded-circle mx-auto mb-0 mb-md-2">
                                                    <i class="fas fa-euro-sign"></i>
                                                </div>
                                            </div>
                                            <div class="col-8 col-md-12 text-start text-md-center">
                                                <h6 class="fw-bold mb-1">Importe total</h6>
                                                <small class="text-muted d-block">Introduce directamente el
                                                    importe</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Opción 2: Cantidad × Precio -->
                            <div class="col-md-4">
                                <div class="calculation-option" data-mode="quantity_price">
                                    <div class="option-card h-100 border rounded-3 p-3 cursor-pointer">
                                        <div class="row align-items-center">
                                            <div class="col-4 col-md-12 text-center text-md-center">
                                                <div class="option-icon bg-primary bg-opacity-10 text-primary rounded-circle mx-auto mb-0 mb-md-2">
                                                    <i class="fas fa-calculator"></i>
                                                </div>
                                            </div>
                                            <div class="col-8 col-md-12 text-start text-md-center">
                                                <h6 class="fw-bold mb-1">Cantidad × Precio</h6>
                                                <small class="text-muted d-block">Calcula por unidades</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Opción 3: Precio por hectárea -->
                            <div class="col-md-4">
                                <div class="calculation-option" data-mode="price_per_ha">
                                    <div class="option-card h-100 border rounded-3 p-3 cursor-pointer">
                                        <div class="row align-items-center">
                                            <div class="col-4 col-md-12 text-center text-md-center">
                                                <div class="option-icon bg-primary bg-opacity-10 text-primary rounded-circle mx-auto mb-0 mb-md-2">
                                                    <i class="fas fa-map"></i>
                                                </div>
                                            </div>
                                            <div class="col-8 col-md-12 text-start text-md-center">
                                                <h6 class="fw-bold mb-1">Por hectárea</h6>
                                                <small class="text-muted d-block">Precio por superficie</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Campos dinámicos según el modo -->
                    <div class="calculation-fields">
                        <!-- Modo: Importe total -->
                        <div class="calculation-group" id="total-fields">
                            <div class="card bg-gray-200">
                                <div class="card-body">
                                    <div class="row align-items-end">
                                        {# @formatter:off #}
                                        {% bootstrap_field form.amount wrapper_class="col-md-3" label_class="required" addon_after="€" %}
                                        {# @formatter:on #}
                                        <div class="col-12 mb-3">
                                            <div class="form-text">Introduce el importe final que aparece en la
                                                factura
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Modo: Cantidad × Precio -->
                        <div class="calculation-group d-none" id="quantity-price-fields">
                            <div class="card bg-gray-200">
                                <div class="card-body">
                                    <div class="row align-items-end">
                                        {# @formatter:off #}
                                        {% bootstrap_field form.quantity wrapper_class="col-md-3 mb-3" label_class="required" %}
                                        {% bootstrap_field form.unit_price wrapper_class="col-md-3" label_class="required" addon_after="€" %}
                                        {# @formatter:on #}
                                        <div class="col-md-3 mt-3">
                                            <label class="form-label fw-semibold">Total</label>
                                            <div class="form-control border-0 px-0 bg-gray-200 fw-bold text-primary"
                                                 id="calculated-total-qp">
                                                0.00 €
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Modo: Precio por hectárea -->
                        <div class="calculation-group d-none" id="price-per-ha-fields">
                            {# @formatter:off #}
                            {% if form.instance.field.area|floatformat:2 != form.instance.field_area_snapshot|floatformat:2 %}
                            {# @formatter:off #}
                            <div class="alert alert-warning">
                                <small>Nota: Originalmente calculado con {{ form.instance.field_area_snapshot }} ha.
                                    Actual: {{ form.instance.field.area }} ha.</small>
                            </div>
                            {% endif %}
                            <div class="card bg-gray-200">
                                <div class="card-body">
                                    <div class="row align-items-end">
                                        {# @formatter:off #}
                                        {% bootstrap_field form.price_per_ha wrapper_class="col-md-3" label_class="required" %}
                                        {# @formatter:on #}
                                        <div class="col-md-3 mt-3">
                                            <label class="form-label fw-semibold">Superficie de la parcela</label>
                                            <div class="form-control bg-light" id="field-area">
                                                <i class="fas fa-map-marked-alt me-2 text-muted"></i>
                                                <span>-- ha</span>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mt-3">
                                            <label class="form-label fw-semibold">Total</label>
                                            <div class="form-control border-0 px-0 bg-gray-200 fw-bold text-primary"
                                                 id="calculated-total-ha">
                                                0.00 €
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <a class="btn btn-secondary" href="{% url 'expense-list' %}">
                            <i class="fa fa-arrow-left"></i>Volver
                        </a>
                        <button class="btn btn-primary" type="submit">
                            <i class="fa fa-save"></i>{{ form.instance.pk|yesno:"Actualizar,Guardar" }}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Pasar datos del backend al JavaScript
    window.fieldAreas = {{ field_areas|safe }};

    document.addEventListener('DOMContentLoaded', function() {
        const calculationModeInput = document.getElementById('id_calculation_mode');
        const fieldSelect = document.getElementById('id_field');
        const quantityInput = document.getElementById('id_quantity');
        const unitPriceInput = document.getElementById('id_unit_price');
        const pricePerHaInput = document.getElementById('id_price_per_ha');
        const amountInput = document.getElementById('id_amount');

        // Datos de hectáreas de parcelas
        const fieldAreas = window.fieldAreas || {};

        // Manejar selección de opciones
        document.querySelectorAll('.calculation-option').forEach(option => {
            option.addEventListener('click', function() {
                const mode = this.dataset.mode;
                selectCalculationMode(mode);
            });
        });

        function selectCalculationMode(mode) {
            // Actualizar el campo oculto
            calculationModeInput.value = mode;

            // Actualizar UI de selección
            document.querySelectorAll('.option-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`[data-mode="${mode}"] .option-card`).classList.add('selected');

            // Mostrar campos correspondientes
            showCalculationFields(mode);
        }

        function showCalculationFields(mode) {
            // Ocultar todos los grupos
            document.querySelectorAll('.calculation-group').forEach(group => {
                group.classList.add('d-none');
            });

            // Mostrar el grupo correspondiente
            const groupId = mode.replaceAll('_', '-') + '-fields';
            const group = document.getElementById(groupId);
            if (group) {
                group.classList.remove('d-none');
            }

            // Limpiar campos no utilizados
            if (mode !== 'quantity_price') {
                quantityInput.value = '';
                unitPriceInput.value = '';
            }
            if (mode !== 'price_per_ha') {
                pricePerHaInput.value = '';
            }
            if (mode !== 'total') {
                amountInput.value = '';
            }

            // Actualizar cálculos
            updateCalculations(mode);
        }

        function updateCalculations(mode) {
            if (mode === 'quantity_price') {
                calculateQuantityPriceTotal();
            } else if (mode === 'price_per_ha') {
                calculatePricePerHaTotal();
            }
        }

        function updateFieldArea() {
            const fieldId = fieldSelect.value;
            const fieldAreaDiv = document.getElementById('field-area');

            if (fieldId && fieldAreas[fieldId]) {
                const area = parseFloat(fieldAreas[fieldId]);
                fieldAreaDiv.innerHTML = `<i class="fas fa-map-marked-alt me-2 text-success"></i><span>${area} ha</span>`;
                calculatePricePerHaTotal();
            } else {
                fieldAreaDiv.innerHTML = `<i class="fas fa-map-marked-alt me-2 text-muted"></i><span>--</span>`;
                document.getElementById('calculated-total-ha').textContent = '0.00 €';
            }
        }

        function calculateQuantityPriceTotal() {
            if (currentMode() !== 'quantity_price') return;

            const quantity = parseFloat(quantityInput.value) || 0;
            const unitPrice = parseFloat(unitPriceInput.value) || 0;
            const total = quantity * unitPrice;

            document.getElementById('calculated-total-qp').textContent = total.toFixed(2) + ' €';
            amountInput.value = total.toFixed(2);
        }

        function calculatePricePerHaTotal() {
            if (currentMode() !== 'price_per_ha') return;

            const pricePerHa = parseFloat(pricePerHaInput.value) || 0;
            const fieldId = fieldSelect.value;
            const area = fieldId && fieldAreas[fieldId] ? parseFloat(fieldAreas[fieldId]) : 0;
            const total = pricePerHa * area;

            document.getElementById('calculated-total-ha').textContent = total.toFixed(2) + ' €';
            amountInput.value = total.toFixed(2);
        }

        function currentMode(){
            return calculationModeInput.value || 'total';
        }

        // Event listeners
        fieldSelect.addEventListener('change', updateFieldArea);
        quantityInput.addEventListener('input', calculateQuantityPriceTotal);
        unitPriceInput.addEventListener('input', calculateQuantityPriceTotal);
        pricePerHaInput.addEventListener('input', calculatePricePerHaTotal);

        // Inicialización
        selectCalculationMode(currentMode());
        updateFieldArea();
    });
</script>
{% endblock %}