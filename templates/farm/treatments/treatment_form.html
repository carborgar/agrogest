{% extends "base.html" %}
{% load widget_tweaks %}
{% load static %}
{% load django_bootstrap5 %}

{% block extra_head %}
<style>
    .btn-add {
        width: 100%;
        border: 2px dashed var(--primary);
        background: rgba(74, 124, 89, 0.05);
        color: var(--primary);
        border-radius: 12px;
        padding: 1rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col">
        <div class="card shadow-sm border-0 rounded-lg">
            <div class="card-header bg-primary text-white py-3">
                <h2 class="mb-0 fs-3">Nuevo tratamiento</h2>
            </div>
            <div class="card-body">
                {% bootstrap_form_errors form %}
                {% bootstrap_formset_errors products_formset %}

                <form data-form-count="{{ products_formset.total_form_count }}" id="treatmentForm" method="post">
                    {% csrf_token %}

                    <!-- Indicador de progreso -->
                    <div class="mb-4">
                        <div class="progress" role="progressbar" style="height: 10px;">
                            <div class="progress-bar bg-primary" id="progressBar" style="width: 50%"></div>
                        </div>
                        <div class="d-flex justify-content-between mt-2 small text-muted">
                            <span>Paso 1: Información General</span>
                            <span>Paso 2: Productos</span>
                        </div>
                    </div>

                    <!-- Step 1: Información General -->
                    <div class="step" id="step1">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-light py-3">
                                <h3 class="m-0 fs-4 text-primary"><i class="fa-solid fa-circle-info"></i> Información
                                    General</h3>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-6 col-lg-4">
                                        <div class="form-floating mb-3">
                                            {{ form.name|add_class:"form-control" }}
                                            <label for="{{ form.name.id_for_label }}">Nombre</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-lg-4">
                                        <div class="form-floating mb-3">
                                            {{ form.type|add_class:"form-select" }}
                                            <label for="{{ form.type.id_for_label }}">Tipo</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-lg-4">
                                        <div class="form-floating mb-3">
                                            {{ form.date|add_class:"form-control" }}
                                            <label for="{{ form.date.id_for_label }}">Fecha</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-lg-4">
                                        <div class="form-floating mb-3">
                                            {{ form.field|add_class:"form-select" }}
                                            <label for="{{ form.field.id_for_label }}">Parcela</label>
                                        </div>
                                        <div class="form-text text-primary fw-semibold" id="fieldAreaInfo"></div>
                                    </div>
                                    <div class="col-md-6 col-lg-4">
                                        <div class="form-floating mb-3">
                                            {{ form.finish_date|add_class:"form-control" }}
                                            <label for="{{ form.finish_date.id_for_label }}">Fecha de
                                                finalización</label>
                                        </div>
                                        <div class="form-text" id="completedDateInfo">Opcional. Si se establece, el
                                            tratamiento se marcará como completado.
                                        </div>
                                    </div>
                                </div>

                                <!-- Campos condicionales (aparecen según el tipo seleccionado) -->
                                <div class="mt-3 d-none" id="conditionalFields">
                                    <hr class="text-muted">
                                    <div class="row g-3">
                                        <div class="col-md-6 col-lg-4" id="machineFieldGroup">
                                            <div class="form-floating mb-3">
                                                {{ form.machine|add_class:"form-select" }}
                                                <label for="{{ form.machine.id_for_label }}">Maquinaria</label>
                                            </div>
                                            <div class="form-text text-primary fw-semibold"
                                                 id="machineCapacityInfo"></div>
                                        </div>
                                        <div class="col-md-6 col-lg-4" id="waterFieldGroup">
                                            <div class="form-floating mb-3">
                                                {{ form.water_per_ha|add_class:"form-control" }}
                                                <label for="{{ form.water_per_ha.id_for_label }}">Mojado</label>
                                            </div>
                                            <div class="form-text">Cantidad de agua a aplicar por hectárea</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer bg-white py-3">
                                <button class="btn btn-primary w-100" id="nextToProducts" type="button">
                                    Continuar a Productos
                                    <i class="bi bi-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Productos -->
                    <div class="step d-none" id="step2">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-light py-3 d-flex justify-content-between align-items-center">
                                <h3 class="m-0 fs-4 text-primary"><i class="fa-solid fa-box"></i> Productos</h3>
                            </div>
                            <div class="card-body">
                                {{ products_formset.management_form }}

                                <div class="treatment-products-grid" id="productsContainer">
                                    {% for form in products_formset %}
                                    <div class="treatment-product-card product-form">
                                        <div class="product-card-header">
                                            <div class="product-number">{{ forloop.counter }}</div>
                                            <button class="btn btn-sm btn-outline-danger rounded-circle remove-row"
                                                    type="button">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>

                                        {{ form.id }}

                                        <div class="row">
                                            <div class="col-12 col-md-6 col-lg-4">
                                                <div class="form-floating mb-3">
                                                    {{ form.product|add_class:"form-select product-select" }}
                                                    <label>Producto</label>
                                                </div>

                                                <div class="dose-info d-none">
                                                    <strong>Dosis recomendada:</strong>
                                                    <span class="recommended-dose">-</span>
                                                </div>
                                            </div>
                                            <div class="col-6 col-lg-4">
                                                <div class="form-floating">
                                                    {{ form.dose|add_class:"form-control product-dose" }}
                                                    <label>Dosis</label>
                                                </div>
                                            </div>
                                            <div class="col-6 col-lg-4">
                                                <div class="form-floating">
                                                    {{ form.total_dose|add_class:"form-control total-dose-input" }}
                                                    <label>Total</label>
                                                </div>
                                            </div>
                                        </div>


                                    </div>
                                    {% endfor %}
                                </div>
                                <button class="btn-add mt-3" id="addProduct" type="button">
                                    <i class="bi bi-plus-circle"></i>
                                    Añadir Producto
                                </button>
                            </div>
                            <div class="card-footer bg-white py-3">
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-primary" id="backToInfo" type="button">
                                        <i class="bi bi-arrow-left me-2"></i>
                                        Atrás
                                    </button>
                                    <button class="btn btn-primary flex-fill" id="saveTreatment" type="submit">
                                        <i class="bi bi-check-circle me-2"></i>
                                        Guardar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<template id="productRowTemplate">
    <div class="treatment-product-card product-form">
        <div class="product-card-header">
            <div class="product-number"></div>
            <button class="btn btn-sm btn-outline-danger rounded-circle remove-row" type="button">
                <i class="bi bi-trash"></i>
            </button>
        </div>

        <input id="id_treatmentproduct_set-INDEX-id" name="treatmentproduct_set-INDEX-id" type="hidden">

        <div class="row">
            <div class="col-12 col-md-6 col-lg-4">
                <div class="form-floating mb-3">
                    <select class="form-select product-select"
                            id="id_treatmentproduct_set-INDEX-product"
                            name="treatmentproduct_set-INDEX-product">
                        <option value="">Seleccione un producto</option>
                    </select>
                    <label>Producto</label>
                </div>

                <div class="dose-info d-none">
                    <strong>Dosis recomendada:</strong>
                    <span class="recommended-dose">-</span>
                </div>
            </div>
            <div class="col-6 col-lg-4">
                <div class="form-floating">
                    <input class="form-control product-dose" id="id_treatmentproduct_set-INDEX-dose" name="treatmentproduct_set-INDEX-dose"
                           step="0.01"
                           type="number">
                    <label>Dosis</label>
                </div>
            </div>
            <div class="col-6 col-lg-4">
                <div class="form-floating">
                    <input class="form-control total-dose-input" id="id_treatmentproduct_set-INDEX-total_dose" name="treatmentproduct_set-INDEX-total_dose"
                           step="0.01"
                           type="number">
                    <label>Total</label>
                </div>
            </div>
        </div>
    </div>
</template>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        // Variables globales
        let fields = {}, machines = {}, products = new Map();
        const formContainer = document.getElementById('treatmentForm');
        let formCount = parseInt(formContainer.dataset.formCount);
        let lastModifiedField = new Map(); // Para trackear el último campo modificado por fila
        const maxForms = parseInt('{{ products_formset.max_num }}');
        const productTemplate = document.getElementById('productRowTemplate');

        // Elementos del formulario
        const elements = {
            fieldSelect: document.getElementById('{{ form.field.id_for_label }}'),
            treatmentTypeSelect: document.getElementById('{{ form.type.id_for_label }}'),
            machineSelect: document.getElementById('{{ form.machine.id_for_label }}'),
            waterPerHaInput: document.getElementById('{{ form.water_per_ha.id_for_label }}'),
            completedDateInput: document.getElementById('{{ form.finish_date.id_for_label }}'),
            fieldInfo: document.getElementById('fieldAreaInfo'),
            machineInfo: document.getElementById('machineCapacityInfo'),
            completedDateInfo: document.getElementById('completedDateInfo'),
            addProductBtn: document.getElementById('addProduct'),
            productsContainer: document.getElementById('productsContainer'),
            totalFormsInput: document.getElementById('id_treatmentproduct_set-TOTAL_FORMS'),
            conditionalFields: document.getElementById('conditionalFields'),
            machineFieldGroup: document.getElementById('machineFieldGroup'),
            waterFieldGroup: document.getElementById('waterFieldGroup'),
            nameInput: document.getElementById('{{ form.name.id_for_label }}'),
            dateInput: document.getElementById('{{ form.date.id_for_label }}'),
            // Step elements
            step1: document.getElementById('step1'),
            step2: document.getElementById('step2'),
            nextToProducts: document.getElementById('nextToProducts'),
            backToInfo: document.getElementById('backToInfo'),
            progressBar: document.getElementById('progressBar')
        };

        // Funciones para cargar datos
        async function fetchData(url) {
            const response = await fetch(url);
            return response.json();
        }

        async function loadFieldsData() {
            fields = Object.fromEntries((await fetchData(API_URLS.fields)).map(field => [field.id, field]));
            updateFieldInfo();
        }

        async function loadMachinesData() {
            machines = Object.fromEntries((await fetchData(API_URLS.machines)).map(machine => [machine.id, machine]));
            updateMachineInfo();
        }

        async function loadProductsData(treatmentType = null) {
            if (!treatmentType) {
                products = new Map();
                return;
            }

            products = new Map((await fetchData(API_URLS.productsByTreatmentType(treatmentType))).map(product => [product.id, product]));

            updateProductsTableOptions();
        }

        function populateProductSelects() {
            document.querySelectorAll('.product-select').forEach(productSelect => {
                const currentValue = productSelect.value;
                productSelect.innerHTML = '<option value="">Seleccione un producto</option>';
                for (const product of products.values()) {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = product.name;
                    if (product.id.toString() === currentValue) option.selected = true;
                    productSelect.appendChild(option);
                }

            });
        }

        function resetProductsContainer() {
            // Simplemente inicializar de nuevo
            initializeFirstRow();
            populateProductSelects();
        }

        function updateProductsTableOptions() {
            // Actualizar todos los selects de productos en la tabla
            document.querySelectorAll('.product-select').forEach(productSelect => {
                const currentValue = productSelect.value;

                // Guardar la opción seleccionada actualmente
                const selectedOption = productSelect.options[productSelect.selectedIndex];
                const selectedText = selectedOption ? selectedOption.text : '';

                // Limpiar y reconstruir las opciones
                productSelect.innerHTML = '<option value="">Seleccione un producto</option>';

                // Añadir las opciones según los productos filtrados
                for (const product of products.values()) {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = product.name;

                    if (product.id.toString() === currentValue) {
                        option.selected = true;
                    }

                    productSelect.appendChild(option);
                }

                // Si el valor anterior ya no existe en las nuevas opciones, limpiar los campos relacionados
                if (productSelect.value !== currentValue) {
                    const row = productSelect.closest('.product-form');
                    if (row) {
                        row.querySelector('.product-dose').value = '';
                        row.querySelector('#product-default-dose').value = '';
                        row.querySelector('.estimated-dose').textContent = '-';
                    }
                }
            });
        }

        // Funciones para actualizar información
        function updateFieldInfo() {
            const field = fields[elements.fieldSelect.value];
            elements.fieldInfo.textContent = field ? `Área: ${field.area} ha - Cultivo: ${field.crop}` : '';
            calculateTotalDoses();
            checkStep1Completion();
        }

        function updateMachineInfo() {
            const machine = machines[elements.machineSelect.value];
            elements.machineInfo.textContent = machine ? `Capacidad: ${machine.capacity} litros` : '';
            calculateTotalDoses();
            checkStep1Completion();
        }

        function getProduct(productId) {
            return products.get(Number(productId)) || null;
        }

        function updateProductInfo(event) {
            const card = event.target.closest('.product-form');
            const product = getProduct(event.target.value);

            const doseInput = card.querySelector('.product-dose');
            const recommendedDoseSpan = card.querySelector('.recommended-dose');
            const totalInput = card.querySelector('.total-dose-input');
            const unitSpan = card.querySelector('.total-unit');
            const doseInfo = card.querySelector('.dose-info');

            if (product) {
                doseInput.value = product.dose;
                recommendedDoseSpan.textContent = product.dose + ' ' + product.dose_type_display;
                doseInfo.classList.remove('d-none');
            } else {
                doseInput.value = '';
                recommendedDoseSpan.textContent = '-';
                doseInfo.classList.add('d-none');
                totalInput.value = '';
            }

            calculateTotalDoses();
        }

        // Función para validar la fecha de finalización
        function validateCompletedDate() {
            const completedDate = elements.completedDateInput.value;
            if (!completedDate) {
                elements.completedDateInfo.textContent = 'Opcional. Si se establece, el tratamiento se marcará como completado.';
                elements.completedDateInfo.classList.remove('text-danger');
                return true;
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const selected = new Date(completedDate);
            selected.setHours(0, 0, 0, 0);

            if (selected > today) {
                elements.completedDateInfo.textContent = 'La fecha de finalización no puede ser en el futuro.';
                elements.completedDateInfo.classList.add('text-danger');
                return false;
            } else {
                elements.completedDateInfo.textContent = 'El tratamiento se registrará como completado en esta fecha.';
                elements.completedDateInfo.classList.add('text-success');
                elements.completedDateInfo.classList.remove('text-danger');
                return true;
            }
        }

        // Función para calcular dosis totales
        function calculateTotalDoses() {
            const field = fields[elements.fieldSelect.value];
            const waterPerHa = parseFloat(elements.waterPerHaInput.value) || 0;
            if (!field) return;

            document.querySelectorAll('.product-form').forEach((card, index) => {
                const doseInput = card.querySelector('.product-dose');
                const totalInput = card.querySelector('.total-dose-input');
                const unitSpan = card.querySelector('.total-unit');
                const productSelect = card.querySelector('.product-select');

                const productId = productSelect.value;
                if (!productId || !getProduct(productId)) {
                    totalInput.value = '';
                    return;
                }

                const dose = parseFloat(doseInput.value) || 0;

                // Si total fue lo último modificado, no recalcular
                if (lastModifiedField.get(index) === 'total' && totalInput.value) {
                    return;
                }

                if (!dose) {
                    totalInput.value = '';
                    return;
                }

                const product = getProduct(productId);
                const doseType = product.dose_type;
                const totalWater = field.area * waterPerHa;
                const unit = doseType.includes('kg') ? 'kg' : 'L';
                let totalDose = 0;

                if (doseType.includes('_per_ha')) {
                    totalDose = dose * field.area;
                } else if (doseType.includes('_per_1000l')) {
                    totalDose = (dose / 1000) * totalWater;
                } else if (doseType.includes('_per_2000l')) {
                    totalDose = (dose / 2000) * totalWater;
                }

                totalInput.value = totalDose.toFixed(2);

            });
        }

        function calculateDoseFromTotal(event) {
            const row = event.target.closest('.product-form');
            const rowIndex = Array.from(document.querySelectorAll('.product-form')).indexOf(row);

            // Marcar que el campo "total" fue el último modificado
            lastModifiedField.set(rowIndex, 'total');

            const doseInput = row.querySelector('.product-dose');
            const estimatedDoseInput = row.querySelector('.total-dose-input');
            const productInput = row.querySelector('.product-select');
            const field = fields[elements.fieldSelect.value];
            const waterPerHa = parseFloat(elements.waterPerHaInput.value) || 0;

            const productId = productInput.value;
            if (!productId || !getProduct(productId) || !field) return;

            const totalDose = parseFloat(estimatedDoseInput.value) || 0;
            if (!totalDose) {
                doseInput.value = '';
                return;
            }

            const doseType = getProduct(productId).dose_type;
            const totalWater = field.area * waterPerHa;
            let dosePerHa = 0;

            if (doseType.includes('_per_ha')) {
                dosePerHa = totalDose / field.area;
            } else if (doseType.includes('_per_1000l')) {
                dosePerHa = (totalDose * 1000) / totalWater;
            } else if (doseType.includes('_per_2000l')) {
                dosePerHa = (totalDose * 2000) / totalWater;
            }

            doseInput.value = dosePerHa.toFixed(2);
        }

        function handleDoseChange(event) {
            const row = event.target.closest('.product-form');
            const rowIndex = Array.from(document.querySelectorAll('.product-form')).indexOf(row);

            // Marcar que el campo "dosis" fue el último modificado
            lastModifiedField.set(rowIndex, 'dose');

            calculateTotalDoses();
        }

        function limitDecimalPlaces(event) {
            const input = event.target;
            const value = input.value;

            // Si contiene un punto decimal
            if (value.includes('.')) {
                const parts = value.split('.');
                // Si hay más de dos decimales después del punto
                if (parts[1] && parts[1].length > 2) {
                    // Truncar a dos decimales
                    input.value = `${parts[0]}.${parts[1].substring(0, 2)}`;
                }
            }
        }

        // Aplicar la restricción a los campos de dosis existentes
        document.querySelectorAll('.product-dose').forEach(input => {
            input.addEventListener('input', limitDecimalPlaces);
        });

        function createProductRowFromTemplate(index) {
            const clone = productTemplate.content.cloneNode(true);

            clone.querySelectorAll('[name*="INDEX"], [id*="INDEX"]').forEach(el => {
                ['name', 'id', 'for'].forEach(attr => {
                    if (el.hasAttribute(attr)) {
                        el.setAttribute(attr, el.getAttribute(attr).replace(/INDEX/g, index));
                    }
                });
            });

            clone.querySelector('.product-number').textContent = index + 1;

            const productSelect = clone.querySelector('.product-select');
            for (const product of products.values()) {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = product.name;
                productSelect.appendChild(option);
            }

            return clone.firstElementChild;
        }


        // Función para añadir eventos a una fila
        function addEventListenersToRow(row, index) {
            const productSelect = row.querySelector('.product-select');
            const doseInput = row.querySelector('.product-dose');
            const totalInput = row.querySelector('.total-dose-input');
            const removeBtn = row.querySelector('.remove-row');

            productSelect.addEventListener('change', updateProductInfo);
            doseInput.addEventListener('input', handleDoseChange);
            doseInput.addEventListener('input', limitDecimalPlaces);
            totalInput.addEventListener('input', (e) => {
                lastModifiedField.set(index, 'total');
                calculateDoseFromTotal(e);
            });
            totalInput.addEventListener('input', limitDecimalPlaces);
            removeBtn.addEventListener('click', () => {
                row.remove();
                updateFormIndexes();
                updateProductsIndexes();
            });
        }

        // Manejo de productos
        function addProductRow() {
            if (formCount >= maxForms) return alert('No se pueden añadir más productos');

            const newRow = createProductRowFromTemplate(formCount);
            const container = document.createElement('div');
            container.appendChild(newRow);
            const rowElement = container.firstChild;

            addEventListenersToRow(rowElement, formCount);

            elements.productsContainer.appendChild(rowElement);
            elements.totalFormsInput.value = ++formCount;
        }

        function updateFormIndexes() {
            document.querySelectorAll('.product-form').forEach((row, index) => {
                row.querySelectorAll('input, select').forEach(el => {
                    ['name', 'id'].forEach(attr => {
                        if (el.hasAttribute(attr)) {
                            el.setAttribute(attr, el.getAttribute(attr).replace(/treatmentproduct_set-\d+-/, `treatmentproduct_set-${index}-`));
                        }
                    });
                });
            });
            elements.totalFormsInput.value = formCount = document.querySelectorAll('.product-form').length;
        }

        function updateProductsIndexes() {
            // recalculate all product-number based on the form count
            document.querySelectorAll('.product-number').forEach((el, index) => {
                el.textContent = index + 1;
            });
        }

        function initializeFirstRow() {
            // Limpiar el contenedor
            elements.productsContainer.innerHTML = '';

            // Añadir primera fila
            const firstRow = createProductRowFromTemplate(0);
            const container = document.createElement('div');
            container.appendChild(firstRow);
            const rowElement = container.firstChild;

            addEventListenersToRow(rowElement, 0);
            elements.productsContainer.appendChild(rowElement);

            formCount = 1;
            elements.totalFormsInput.value = formCount;
        }

        // Funcionalidad Step Form
        function showStep(stepNumber) {
            if (stepNumber === 1) {
                elements.step1.classList.remove('d-none');
                elements.step2.classList.add('d-none');
                elements.progressBar.style.width = '50%';
            } else {
                elements.step1.classList.add('d-none');
                elements.step2.classList.remove('d-none');
                elements.progressBar.style.width = '100%';
            }
        }

        function checkStep1Completion() {
            const treatmentType = elements.treatmentTypeSelect.value;
            const fieldSelected = elements.fieldSelect.value;
            const machineSelected = elements.machineSelect.value;
            const waterPerHaValue = elements.waterPerHaInput.value;
            const completedDateValid = validateCompletedDate();
            const nameValue = elements.nameInput.value;
            const dateValue = elements.dateInput.value;

            const requiredFieldsFilled =
                fieldSelected !== '' &&
                treatmentType !== '' &&
                nameValue !== '' &&
                dateValue !== '';

            let conditionalFieldsValid = true;

            if (treatmentType === 'spraying') {
                conditionalFieldsValid = machineSelected !== '' && waterPerHaValue !== '';
            }

            elements.nextToProducts.disabled = !(requiredFieldsFilled && conditionalFieldsValid && completedDateValid);
        }

        // Manejo de cambio en tipo de tratamiento
        function handleTreatmentTypeChange() {
            const selectedType = elements.treatmentTypeSelect.value;

            // Mostrar/ocultar los campos condicionales
            if (!selectedType) {
                elements.conditionalFields.classList.add('d-none');
                elements.machineSelect.disabled = true;
                elements.waterPerHaInput.disabled = true;
                return;
            } else {
                elements.conditionalFields.classList.remove('d-none');
            }

            if (selectedType === 'spraying') {
                // Para pulverización: habilitar máquina y mojado
                elements.machineFieldGroup.classList.remove('d-none');
                elements.waterFieldGroup.classList.remove('d-none');
                elements.machineSelect.disabled = false;
                elements.machineSelect.required = true;
                elements.waterPerHaInput.disabled = false;
                elements.waterPerHaInput.required = true;

                // Establecer valor por defecto de mojado a 850 cuando se selecciona una máquina
                if (!elements.waterPerHaInput.value || elements.waterPerHaInput.value === '0') {
                    elements.waterPerHaInput.value = '850';
                }

            }
            else if (selectedType === 'fertigation') {
                // Para fertirrigación: ocultar máquina y mojado
                elements.machineFieldGroup.classList.add('d-none');
                elements.waterFieldGroup.classList.add('d-none');
                elements.machineSelect.disabled = true;
                elements.machineSelect.required = false;
                elements.machineSelect.value = '';
                elements.waterPerHaInput.value = '0';
                elements.waterPerHaInput.required = false;
            }

            checkStep1Completion();
        }

        // Validación de formulario
        function validateForm(event) {
            const selectedType = elements.treatmentTypeSelect.value;
            const nameValue = elements.nameInput.value;
            const dateValue = elements.dateInput.value;

            // Check name field
            if (!nameValue) {
                event.preventDefault();
                alert('Debe ingresar un nombre para el tratamiento');
                showStep(1);
                return false;
            }

            // Check date field
            if (!dateValue) {
                event.preventDefault();
                alert('Debe seleccionar una fecha para el tratamiento');
                showStep(1);
                return false;
            }

            if (!selectedType) {
                event.preventDefault();
                alert('Debe seleccionar un tipo de tratamiento');
                showStep(1);
                return false;
            }

            if (selectedType === 'spraying') {
                // Validar máquina seleccionada
                if (!elements.machineSelect.value) {
                    event.preventDefault();
                    alert('Para tratamientos de pulverización, debe seleccionar una máquina');
                    showStep(1);
                    return false;
                }

                // Validar mojado
                if (!elements.waterPerHaInput.value) {
                    event.preventDefault();
                    alert('Para tratamientos de pulverización, debe indicar el volumen de caldo (L/ha)');
                    showStep(1);
                    return false;
                }
            }

            // Validar que al menos hay un producto
            const validProducts = Array.from(document.querySelectorAll('.product-form')).filter(row => {
                const productSelect = row.querySelector('.product-select');
                const dose = row.querySelector('.product-dose');
                return productSelect.value && dose.value;
            });

            if (validProducts.length === 0) {
                event.preventDefault();
                alert('Debe agregar al menos un producto al tratamiento');
                showStep(2);
                return false;
            }

            // Validar fecha de finalización
            if (elements.completedDateInput.value) {
                if (!validateCompletedDate()) {
                    event.preventDefault();
                    alert('La fecha de finalización no puede ser en el futuro');
                    showStep(1);
                    return false;
                }
            }

            return true;
        }

        // Añadir event listeners
        elements.fieldSelect.addEventListener('change', updateFieldInfo);
        elements.treatmentTypeSelect.addEventListener('change', handleTreatmentTypeChange);
        elements.machineSelect.addEventListener('change', updateMachineInfo);
        elements.waterPerHaInput.addEventListener('input', calculateTotalDoses);
        elements.waterPerHaInput.addEventListener('input', checkStep1Completion);
        elements.machineSelect.addEventListener('change', checkStep1Completion);
        elements.fieldSelect.addEventListener('change', checkStep1Completion);
        elements.treatmentTypeSelect.addEventListener('change', checkStep1Completion);
        elements.completedDateInput.addEventListener('change', validateCompletedDate);
        elements.completedDateInput.addEventListener('change', checkStep1Completion);
        elements.addProductBtn.addEventListener('click', addProductRow);
        elements.nameInput.addEventListener('input', checkStep1Completion);
        elements.dateInput.addEventListener('change', checkStep1Completion);

        // Event listeners para cambio de paso
        elements.nextToProducts.addEventListener('click', async () => {
            const selectedType = elements.treatmentTypeSelect.value;

            // Cargar los productos específicos para este tipo antes de mostrar el paso 2
            await loadProductsData(selectedType);

            // Reiniciar la tabla de productos
            resetProductsContainer();

            // Avanzar al paso 2
            showStep(2);
        });

        elements.backToInfo.addEventListener('click', () => showStep(1));

        // Eventos para eliminar productos
        document.querySelectorAll('.remove-row').forEach(button => button.addEventListener('click', function() {
            this.closest('.product-form').remove();
            updateFormIndexes();
            updateProductsIndexes();
        }));

        // Eventos para calcular dosis
        document.querySelectorAll('.product-dose').forEach((el, index) => {
            el.addEventListener('input', handleDoseChange);
            // Inicializar el tracking para las filas existentes
            lastModifiedField.set(index, null);
        });

        document.querySelectorAll('.product-select').forEach(select => select.addEventListener('change', updateProductInfo));
        document.querySelectorAll('.total-dose-input').forEach(input => {
            input.addEventListener('input', calculateDoseFromTotal);
            input.addEventListener('input', limitDecimalPlaces);
        });

        // Validación en envío del formulario
        document.getElementById('treatmentForm').addEventListener('submit', validateForm);

        document.querySelectorAll('.total-dose-input').forEach((input, index) => {
            input.addEventListener('input', (e) => {
                lastModifiedField.set(index, 'total');
                calculateDoseFromTotal(e);
            });
        });

        // Inicialización
        await loadFieldsData();
        await loadMachinesData();
        handleTreatmentTypeChange();
        initializeFirstRow(); // Crear primera fila desde template
        checkStep1Completion();

    });
</script>
{% endblock %}
