{% extends "base.html" %}

{% load django_bootstrap5 %}

{% block header %}
{% if object.pk %}Editar producto{% else %}Nuevo producto{% endif %}
{% endblock %}

{% block sub_header %}
Define las propiedades y dosis del producto para diferentes métodos de aplicación.
{% endblock %}


{% block extra_head %}
<style>
    /* Steps Navigation */
    .steps-navigation {
       background: white;
       border-radius: 12px;
       padding: 1.5rem 0;
       box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .step-item {
       display: flex;
       padding: 1rem 1.5rem;
       margin-bottom: 0.5rem;
       cursor: pointer;
       transition: all 0.3s ease;
       border-left: 3px solid transparent;
       position: relative;
    }

    .step-item.active {
       background-color: #f8f9ff;
       border-left-color: #0d6efd;
    }

    .step-item.completed {
       background-color: #f0f9f4;
       border-left-color: #198754;
    }

    .step-icon {
       width: 40px;
       height: 40px;
       border-radius: 50%;
       background-color: #e9ecef;
       display: flex;
       align-items: center;
       justify-content: center;
       margin-right: 1rem;
       transition: all 0.3s ease;
       flex-shrink: 0;
    }

    .step-item.active .step-icon {
       background-color: #0d6efd;
       color: white;
    }

    .step-item.completed .step-icon {
       background-color: #198754;
       color: white;
    }

    .step-content {
       flex: 1;
    }

    .step-title {
       font-size: 0.9rem;
       font-weight: 600;
       margin: 0 0 0.25rem 0;
       color: #495057;
    }

    .step-item.active .step-title {
       color: #0d6efd;
    }

    .step-item.completed .step-title {
       color: #198754;
    }

    .step-description {
       font-size: 0.8rem;
       color: #6c757d;
       margin: 0;
       line-height: 1.3;
    }

    /* Form Panels */
    .step-content-panel {
       display: none;
    }

    .step-content-panel.active {
       display: block;
    }

    /* Form Fields States */
    .spraying-fields,
    .fertigation-fields {
       opacity: 0.5;
       pointer-events: none;
       transition: all 0.3s ease;
    }

    .spraying-fields.enabled,
    .fertigation-fields.enabled {
       opacity: 1;
       pointer-events: auto;
    }

    /* Enhanced styling */
    .card {
       border: none;
       box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
       border-radius: 12px;
    }

    .card-header {
       background-color: #fff;
       border-bottom: 1px solid #e9ecef;
       border-radius: 12px 12px 0 0 !important;
       padding: 1.25rem 1.5rem;
    }

    .card-body {
       padding: 1.5rem;
    }

    /* Mobile Responsive */
    @media (max-width: 991.98px) {
       .steps-navigation {
           position: relative !important;
           top: auto !important;
       }

       .step-item {
           padding: 0.75rem 1rem;
       }

       .step-icon {
           width: 32px;
           height: 32px;
           margin-right: 0.75rem;
       }

       .step-title {
           font-size: 0.85rem;
       }

       .step-description {
           font-size: 0.75rem;
       }
    }

    @media (max-width: 575.98px) {
       .steps-navigation {
           display: flex;
           overflow-x: auto;
           padding: 1rem 0.5rem;
           gap: 0.5rem;
       }

       .step-item {
           flex-direction: column;
           align-items: center;
           text-align: center;
           min-width: 80px;
           padding: 0.75rem 0.5rem;
           margin-bottom: 0;
           border-left: none;
           border-bottom: 3px solid transparent;
       }

       .step-item.active {
           background-color: #f8f9ff;
           border-bottom-color: #0d6efd;
       }

       .step-item.completed {
           background-color: #f0f9f4;
           border-bottom-color: #198754;
       }

       .step-item::after {
           display: none;
       }

       .step-icon {
           margin-right: 0;
           margin-bottom: 0.5rem;
       }

       .step-description {
           display: none;
       }

       .card-body {
           padding: 1rem;
       }

       .card-header {
           padding: 1rem;
       }

       .step-btn {
           width: 100%;
           margin-bottom: 0.5rem;
       }

       .d-flex.justify-content-between {
           flex-direction: column;
       }

       .ms-auto {
           margin-left: 0 !important;
           margin-top: 1rem;
       }
    }
</style>
{% endblock %}

{% block content %}

<form id="productForm" method="post" novalidate>
    {% csrf_token %}

    <div class="row">
        <!-- Steps Navigation -->
        <div class="col-lg-3 mb-4">
            <div class="steps-navigation" style="top: 2rem;">
                <div class="step-item active" data-step="1">
                    <div class="step-icon">
                        <i class="fa fa-info-circle"></i>
                    </div>
                    <div class="step-content">
                        <h6 class="step-title text-break">Información básica</h6>
                        <p class="step-description">Nombre, tipo y precio</p>
                    </div>
                </div>

                <div class="step-item" data-step="2">
                    <div class="step-icon">
                        <i class="fa fa-spray-can"></i>
                    </div>
                    <div class="step-content">
                        <h6 class="step-title text-break">Pulverización</h6>
                        <p class="step-description">Dosis para aplicación foliar</p>
                    </div>
                </div>

                <div class="step-item" data-step="3">
                    <div class="step-icon">
                        <i class="fa fa-droplet"></i>
                    </div>
                    <div class="step-content">
                        <h6 class="step-title text-break">Fertirrigación</h6>
                        <p class="step-description">Dosis para riego localizado</p>
                    </div>
                </div>

                <div class="step-item" data-step="4">
                    <div class="step-icon">
                        <i class="fa fa-check-circle"></i>
                    </div>
                    <div class="step-content">
                        <h6 class="step-title text-break">Finalizar</h6>
                        <p class="step-description">Revisar y guardar</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Content -->
        <div class="col-lg-9">
            <!-- Step 1: Basic Information -->
            <div class="step-content-panel active" id="step-1">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fa fa-info-circle text-primary me-2"></i>
                            Información básica del producto
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {# @formatter:off #}
                            {% bootstrap_field form.name wrapper_class="col-12" label_class="required"%}
                            {% bootstrap_field form.product_type wrapper_class="col-md-6 mt-3" label_class="required" %}
                            {% bootstrap_field form.price wrapper_class="col-md-6 mt-3" label_class="required" addon_after="€" %}
                            {% bootstrap_field form.comments wrapper_class="col-12" %}
                            {# @formatter:on #}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Spraying Configuration -->
            <div class="step-content-panel" id="step-2">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fa fa-spray-can text-info me-2"></i>
                            Configuración para pulverización
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info border-0 mb-4">
                            <i class="fa fa-info-circle me-2"></i>
                            <strong>Pulverización:</strong> Aplicación foliar del producto mediante
                            pulverizador.
                            Completa ambos campos si el producto se puede aplicar por este método.
                        </div>

                        <div class="form-check form-switch mb-4">
                            <input class="form-check-input" id="enableSpraying" type="checkbox">
                            <label class="form-check-label fw-bold" for="enableSpraying">
                                Habilitar aplicación por pulverización
                            </label>
                        </div>

                        <div class="spraying-fields" id="sprayingFields">
                            <div class="row">
                                {% bootstrap_field form.spraying_dose wrapper_class="col-md-6 mb-3" %}
                                {% bootstrap_field form.spraying_dose_type wrapper_class="col-md-6 mb-3" %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Fertigation Configuration -->
            <div class="step-content-panel" id="step-3">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fa fa-droplet text-success me-2"></i>
                            Configuración para fertirrigación
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-success border-0 mb-4">
                            <i class="fa fa-info-circle me-2"></i>
                            <strong>Fertirrigación:</strong> Aplicación del producto a través del sistema de
                            riego.
                            Completa ambos campos si el producto se puede aplicar por este método.
                        </div>

                        <div class="form-check form-switch mb-4">
                            <input class="form-check-input" id="enableFertigation" type="checkbox">
                            <label class="form-check-label fw-bold" for="enableFertigation">
                                Habilitar aplicación por fertirrigación
                            </label>
                        </div>

                        <div class="fertigation-fields" id="fertigationFields">
                            <div class="row">
                                {% bootstrap_field form.fertigation_dose wrapper_class="col-md-6 mb-3" %}
                                {% bootstrap_field form.fertigation_dose_type wrapper_class="col-md-6 mb-3" %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 4: Review and Submit -->
            <div class="step-content-panel" id="step-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fa fa-check-circle text-success me-2"></i>
                            Revisar información
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="review-section mb-4">
                            <h6 class="text-muted mb-3">Información básica</h6>
                            <div class="row mb-3">
                                <div class="col-sm-3"><strong>Nombre:</strong></div>
                                <div class="col-sm-9" id="review-name">-</div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-sm-3"><strong>Tipo:</strong></div>
                                <div class="col-sm-9" id="review-type">-</div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-sm-3"><strong>Precio:</strong></div>
                                <div class="col-sm-9" id="review-price">-</div>
                            </div>
                        </div>

                        <div class="review-section mb-4">
                            <h6 class="text-muted mb-3">Métodos de aplicación</h6>
                            <div class="row mb-2">
                                <div class="col-sm-3"><strong>Pulverización:</strong></div>
                                <div class="col-sm-9" id="review-spraying">-</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-sm-3"><strong>Fertirrigación:</strong></div>
                                <div class="col-sm-9" id="review-fertigation">-</div>
                            </div>
                        </div>

                        <div class="alert alert-warning border-0" id="validation-warning"
                             style="display: none;">
                            <i class="fa fa-exclamation-triangle me-2"></i>
                            <strong>Atención:</strong> El producto debe tener al menos una configuración válida
                            (pulverización o fertirrigación).
                        </div>

                        <!-- Form errors display -->
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger border-0 mb-3">
                            <i class="fa fa-exclamation-circle me-2"></i>
                            {% for error in form.non_field_errors %}
                            {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="d-flex justify-content-between mt-4">
                <button class="btn btn-outline-secondary step-btn" id="prevBtn" style="display: none;" type="button">
                    <i class="fa fa-arrow-left me-2"></i>Anterior
                </button>

                <div class="ms-auto">
                    <button class="btn btn-primary step-btn" id="nextBtn" type="button">
                        Siguiente<i class="fa fa-arrow-right ms-2"></i>
                    </button>
                    <button class="btn btn-primary step-btn" id="submitBtn" style="display: none;" type="submit">
                        <i class="fa fa-save me-2"></i>
                        {% if object.pk %}Actualizar producto{% else %}Crear producto{% endif %}
                    </button>
                </div>
            </div>
        </div>
    </div>
</form>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        let currentStep = 1;
        const totalSteps = 4;

        // Elements
        const stepItems = document.querySelectorAll('.step-item');
        const stepPanels = document.querySelectorAll('.step-content-panel');
        const nextBtn = document.getElementById('nextBtn');
        const prevBtn = document.getElementById('prevBtn');
        const submitBtn = document.getElementById('submitBtn');

        // Form elements
        const sprayingSwitch = document.getElementById('enableSpraying');
        const fertigationSwitch = document.getElementById('enableFertigation');
        const sprayingFields = document.getElementById('sprayingFields');
        const fertigationFields = document.getElementById('fertigationFields');

        // Initialize form state
        initializeForm();

        function initializeForm() {
            // Check if product has existing spraying configuration
            const sprayingDose = document.getElementById('{{ form.spraying_dose.id_for_label }}').value;
            const sprayingDoseType = document.getElementById('{{ form.spraying_dose_type.id_for_label }}').value;

            if (sprayingDose || sprayingDoseType) {
                sprayingSwitch.checked = true;
                sprayingFields.classList.add('enabled');
            }

            // Check if product has existing fertigation configuration
            const fertigationDose = document.getElementById('{{ form.fertigation_dose.id_for_label }}').value;
            const fertigationDoseType = document.getElementById('{{ form.fertigation_dose_type.id_for_label }}').value;

            if (fertigationDose || fertigationDoseType) {
                fertigationSwitch.checked = true;
                fertigationFields.classList.add('enabled');
            }

            updateReview();
        }

        // Step navigation
        function showStep(step) {
            // Hide all panels
            stepPanels.forEach(panel => panel.classList.remove('active'));
            stepItems.forEach(item => item.classList.remove('active'));

            // Show current panel
            document.getElementById(`step-${step}`).classList.add('active');
            document.querySelector(`[data-step="${step}"]`).classList.add('active');

            // Update navigation buttons
            prevBtn.style.display = step === 1 ? 'none' : 'inline-block';
            nextBtn.style.display = step === totalSteps ? 'none' : 'inline-block';
            submitBtn.style.display = step === totalSteps ? 'inline-block' : 'none';

            // Mark completed steps
            stepItems.forEach((item, index) => {
                if (index < step - 1) {
                    item.classList.add('completed');
                } else {
                    item.classList.remove('completed');
                }
            });

            currentStep = step;

            if (step === 4) {
                updateReview();
            }
        }

        // Switch handlers
        sprayingSwitch.addEventListener('change', function() {
            if (this.checked) {
                sprayingFields.classList.add('enabled');
            } else {
                sprayingFields.classList.remove('enabled');
                // Clear fields when disabled
                document.getElementById('{{ form.spraying_dose.id_for_label }}').value = '';
                document.getElementById('{{ form.spraying_dose_type.id_for_label }}').value = '';
            }
        });

        fertigationSwitch.addEventListener('change', function() {
            if (this.checked) {
                fertigationFields.classList.add('enabled');
            } else {
                fertigationFields.classList.remove('enabled');
                // Clear fields when disabled
                document.getElementById('{{ form.fertigation_dose.id_for_label }}').value = '';
                document.getElementById('{{ form.fertigation_dose_type.id_for_label }}').value = '';
            }
        });

        // Navigation button handlers
        nextBtn.addEventListener('click', function() {
            if (currentStep < totalSteps) {
                showStep(currentStep + 1);
            }
        });

        prevBtn.addEventListener('click', function() {
            if (currentStep > 1) {
                showStep(currentStep - 1);
            }
        });

        // Step item click handlers
        stepItems.forEach((item, index) => {
            item.addEventListener('click', () => {
                showStep(index + 1);
            });
        });

        // Update review section
        function updateReview() {
            // Basic info
            const name = document.getElementById('{{ form.name.id_for_label }}').value || '-';
            const typeSelect = document.getElementById('{{ form.product_type.id_for_label }}');
            const type = typeSelect.options[typeSelect.selectedIndex]?.text || '-';
            const price = document.getElementById('{{ form.price.id_for_label }}').value;

            document.getElementById('review-name').textContent = name;
            document.getElementById('review-type').textContent = type;
            document.getElementById('review-price').textContent = price ? `${price}€` : '-';

            // Application methods
            const sprayingDose = document.getElementById('{{ form.spraying_dose.id_for_label }}').value;
            const sprayingType = document.getElementById('{{ form.spraying_dose_type.id_for_label }}').value;
            const fertigationDose = document.getElementById('{{ form.fertigation_dose.id_for_label }}').value;
            const fertigationType = document.getElementById('{{ form.fertigation_dose_type.id_for_label }}').value;

            const typeLabels = {
                'l_per_1000l': 'L/1000L',
                'kg_per_1000l': 'kg/1000L',
                'kg_per_ha': 'kg/ha',
                'l_per_ha': 'L/ha',
                'pct': '%'
            };

            const sprayingText = (sprayingDose && sprayingType) ?
                `${sprayingDose} ${typeLabels[sprayingType]}` :
                'No configurado';

            const fertigationText = (fertigationDose && fertigationType) ?
                `${fertigationDose} ${typeLabels[fertigationType]}` :
                'No configurado';

            document.getElementById('review-spraying').textContent = sprayingText;
            document.getElementById('review-fertigation').textContent = fertigationText;

            // Validation warning
            const hasSprayingConfig = sprayingDose && sprayingType;
            const hasFertigationConfig = fertigationDose && fertigationType;
            const validationWarning = document.getElementById('validation-warning');

            if (!hasSprayingConfig && !hasFertigationConfig) {
                validationWarning.style.display = 'block';
            } else {
                validationWarning.style.display = 'none';
            }
        }

        // Form submission validation
        document.getElementById('productForm').addEventListener('submit', function(e) {
            const sprayingDose = document.getElementById('{{ form.spraying_dose.id_for_label }}').value;
            const sprayingType = document.getElementById('{{ form.spraying_dose_type.id_for_label }}').value;
            const fertigationDose = document.getElementById('{{ form.fertigation_dose.id_for_label }}').value;
            const fertigationType = document.getElementById('{{ form.fertigation_dose_type.id_for_label }}').value;

            const hasSprayingConfig = sprayingDose && sprayingType;
            const hasFertigationConfig = fertigationDose && fertigationType;

            if (!hasSprayingConfig && !hasFertigationConfig) {
                e.preventDefault();
                showNotification({
                    icon: 'error',
                    title: 'Configuración incompleta',
                    text: 'El producto debe tener al menos una configuración válida (pulverización o fertirrigación).'
                });
                showStep(2); // Go back to spraying step
                return false;
            }
        });

        // Initialize first step
        showStep(1);

    });
</script>
{% endblock %}
