{% extends "base.html" %}
{% load custom_filters %}

{% block title %}{{ treatment.name }}{% endblock %}

{% block extra_head %}
<style>
    .product-card {
      transition: all 0.3s ease;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      height: 100%;
      border: none;
      overflow: hidden;
    }

    .product-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .product-card .card-body {
      padding: 0.75rem;
    }

    .product-card .card-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding-bottom: 0.25rem;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .product-card .card-text {
      font-size: 0.9rem;
    }

    .product-card .dose-amount {
      font-size: 1.1rem;
      font-weight: 700;
      color: #0d6efd;
    }

    .product-card .dose-unit {
      font-size: 0.85rem;
      font-weight: 500;
    }

    /* Estilos para máquina completa vs parcial */
    .full-machine .product-card {
      background-color: #f8f9fa;
      border-left: 4px solid #28a745;
    }

    .partial-machine .product-card {
      background-color: #fff8e6;
      border-left: 4px solid #ffc107;
    }

    /* Mejoras para los encabezados de secciones */
    .machine-header {
      padding: 0.75rem 1rem;
      border-radius: 6px 6px 0 0;
      font-weight: 500;
    }

    .machine-header i {
      margin-right: 0.5rem;
    }

    .full-machine-header {
      background-color: #d4edda;
      color: #0f5132;
      border-bottom: 2px solid #28a745;
    }

    .partial-machine-header {
      background-color: #fff3cd;
      color: #856404;
      border-bottom: 2px solid #ffc107;
    }

    /* Totales y resumen */
    .treatment-summary {
      background-color: #e9f2ff;
      padding: 0.75rem;
      border-radius: 6px;
      margin-bottom: 1rem;
      border-left: 4px solid #0d6efd;
    }

    .treatment-summary strong {
      color: #0d6efd;
    }

    /* Nuevos estilos para los precios */
    .price-tag {
      font-size: 0.95rem;
      font-weight: 600;
      color: #198754;
    }

    .price-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      margin-top: 0.5rem;
      padding-top: 0.5rem;
      border-top: 1px dashed rgba(0, 0, 0, 0.1);
    }

    .price-item {
      font-size: 0.8rem;
      display: flex;
      flex-direction: column;
      margin-right: 0.5rem;
    }

    .price-label {
      color: #6c757d;
      font-size: 0.7rem;
    }

    .price-value {
      font-weight: 600;
      color: #198754;
    }

    /* Ajustes para móviles */
    @media (max-width: 767.98px) {
      .product-card {
        margin-bottom: 0.75rem;
      }

      .price-container {
        flex-direction: column;
      }

      .price-item {
        margin-bottom: 0.25rem;
      }
    }

    /* Estilos para la columna de información vertical */
    .info-item-vertical {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .info-item-vertical:last-child {
        border-bottom: none;
    }

    .info-item-vertical .info-label {
        font-size: 0.75rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.25rem;
    }

    .info-item-vertical .info-value {
        font-size: 0.95rem;
        font-weight: 600;
        color: #212529;
    }

    .info-item-vertical .info-subvalue {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }

    /* Estilos para el estado */
    .info-item-vertical.status-success {
        border-left: 4px solid #28a745;
    }

    .info-item-vertical.status-warning {
        border-left: 4px solid #ffc107;
    }

    .info-item-vertical.status-danger {
        border-left: 4px solid #dc3545;
    }

    /* Estilos para productos */
    .product-card {
        transition: all 0.3s ease;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        height: 100%;
        border: none;
        overflow: hidden;
    }

    .product-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .product-card .card-title {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        padding-bottom: 0.25rem;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    /* Estilos para los precios compactos */
    .price-container {
        margin-top: 0.5rem;
        padding-top: 0.5rem;
        border-top: 1px dashed rgba(0, 0, 0, 0.1);
    }

    .price-tag {
        font-size: 0.85rem;
        color: #198754;
        display: block;
    }

    .price-tag strong {
        color: #198754;
    }

    .price-tag .text-muted {
        font-size: 0.8rem;
    }
</style>
{% endblock %}

{% block header %}
<div class="d-flex justify-content-between align-items-center">
    <span>{{ treatment.name }}</span>

    <div class="dropdown">
        <button aria-expanded="false" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown"
                id="treatmentActionsDropdown" type="button">
            <i class="fa fa-cog me-1"></i><span class="d-none d-sm-inline">Acciones</span>
        </button>
        <ul aria-labelledby="treatmentActionsDropdown" class="dropdown-menu dropdown-menu-end dropdown-menu-light">
            {% if not treatment.is_completed %}
            <li><a class="dropdown-item" href="#" onclick="finishTreatment({{ treatment.id }}); return false;">
                <i class="fa fa-check-circle me-2 text-success"></i>Finalizar tratamiento
            </a></li>
            <li>
                <hr class="dropdown-divider">
            </li>
            {% endif %}
            <li><a class="dropdown-item text-danger" href="#" onclick="confirmDelete(); return false;">
                <i class="fa fa-trash me-2"></i>Eliminar
            </a></li>
        </ul>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-3">
        <div class="card mb-3 print-friendly">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0">Información</h3>
            </div>
            <div class="card-body p-0">
                <!-- Estado -->
                <div class="info-item-vertical status-{{ treatment.state_class }}">
                    <div class="info-label"><i class="fa fa-clipboard-check me-2"></i>Estado</div>
                    <div class="info-value">{{ treatment.status_display }}</div>
                </div>

                <!-- Tipo -->
                <div class="info-item-vertical">
                    <div class="info-label"><i class="fa fa-spray-can me-2"></i>Tipo</div>
                    <div class="info-value">{{ treatment.get_type_display }}</div>
                </div>

                <!-- Fecha -->
                <div class="info-item-vertical">
                    <div class="info-label"><i class="fa fa-calendar-alt me-2"></i>Fecha</div>
                    <div class="info-value">{{ treatment.date|date:"d/m/Y" }}</div>
                </div>

                {% if treatment.finish_date %}
                <!-- Fecha finalización -->
                <div class="info-item-vertical">
                    <div class="info-label"><i class="fa fa-calendar-check me-2"></i>Finalizado</div>
                    <div class="info-value">{{ treatment.finish_date|date:"d/m/Y" }}</div>
                </div>
                {% endif %}

                <!-- Parcela -->
                <div class="info-item-vertical">
                    <div class="info-label"><i class="fa fa-map-marked-alt me-2"></i>Parcela</div>
                    <div class="info-value">{{ treatment.field.name }}</div>
                    <div class="info-subvalue">{{ treatment.field.crop }}, {{ treatment.field.area }} ha</div>
                </div>

                {% if treatment.machine %}
                <!-- Maquinaria -->
                <div class="info-item-vertical">
                    <div class="info-label"><i class="fa fa-tractor me-2"></i>Maquinaria</div>
                    <div class="info-value">{{ treatment.machine.name }}</div>
                    <div class="info-subvalue">{{ treatment.machine.capacity }} litros</div>
                </div>

                <!-- Mojado -->
                <div class="info-item-vertical">
                    <div class="info-label"><i class="fa fa-fill-drip me-2"></i>Mojado</div>
                    <div class="info-value">{{ treatment.water_per_ha }} litros/ha</div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-9">
        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0">Productos, dosis y precios</h3>
            </div>
            <div class="card-body">
                <div class="treatment-summary">
                    <i class="fa fa-leaf me-2"></i>Total: <strong>{{ products|length }}</strong> productos aplicados en
                    <strong>{{ treatment.field.name }}</strong>
                    {% if total_cost %}
                    <br>
                    <i class="fa fa-euro-sign me-2"></i>Coste total: <strong>{{ total_cost|floatformat:2 }}€</strong>
                    ({{ cost_per_ha|floatformat:2 }} €/ha)
                    {% endif %}
                </div>

                <div class="row" id="productsContainer">
                    {% for product in products %}
                    <div class="col-md-4 mb-3 product-item">
                        <div class="card product-card"
                             style="background-color: #f8f9fa; border-left: 4px solid #28a745;">
                            <div class="card-body">
                                <h6 class="card-title">{{ product.product.name }}</h6>
                                <p class="card-text mb-1">
                                    <small>{{ product.product.product_type.name }}</small>
                                </p>
                                <p class="card-text mb-0">
                                    <span class="dose-amount">{{ product.dose }}</span>
                                    <span class="dose-unit">{{ product.dose_type|dose_type }}</span>
                                </p>
                                <p class="card-text mb-0">
                                    Total: <span class="dose-amount">{{ product.total_dose|floatformat:2 }}</span>
                                    <span class="dose-unit">{{ product.total_dose_unit }}</span>
                                </p>

                                <!-- Información de precios -->
                                {% if product.unit_price > 0 %}
                                <div class="price-container">
                                    <small class="price-tag">
                                        <i class="fa fa-tag me-1"></i>{{ product.unit_price|floatformat:2 }}€/ud ·
                                        <strong>{{ product.total_price|floatformat:2 }}€</strong>
                                        <span class="text-muted">({{ product.price_per_ha|floatformat:2 }}€/ha)</span>
                                    </small>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="d-flex justify-content-center">
                    <ul class="pagination pagination-sm" id="productsPagination">
                        <!-- La paginación se genera con JavaScript -->
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

{% if treatment.machine and treatment.type == 'spraying' %}
<div class="card mb-4 shadow-sm">
    <div class="card-header bg-primary text-white">
        <h3 class="mb-0">Instrucciones para operador</h3>
    </div>
    <div class="card-body">
        {% with load_info=treatment.calculate_machine_loads %}
        {% if load_info %}
        <div class="treatment-summary">
            <i class="fa fa-info-circle me-2"></i>
            Total: <strong>{{ load_info.total_water }} litros</strong> de agua
            para <strong>{{ treatment.field.area }} ha</strong> a <strong>{{ treatment.water_per_ha }} l/ha</strong>
        </div>

        <!-- Productos para máquina completa -->
        <div class="card mb-3">
            <div class="card-header machine-header full-machine-header">
                <h5 class="mb-0"><i class="fa fa-tractor"></i>{{ load_info.full_loads }} máquinas completas con:
                </h5>
            </div>
            <div class="card-body full-machine">
                <div class="row">
                    {% for product in products %}
                    <div class="col-6 col-sm-3 mb-2">
                        <div class="card product-card">
                            <div class="card-body">
                                <h6 class="card-title">{{ product.product.name }}</h6>
                                <p class="card-text mb-0">
                                    <span class="dose-amount">{{ product.get_dose_per_load }}</span>
                                    <span class="dose-unit">{{ product.total_dose_unit }}</span>
                                </p>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Productos para máquina parcial (si existe) -->
        {% if load_info.partial_load %}
        <div class="card">
            <div class="card-header machine-header partial-machine-header">
                <h5 class="mb-0"><i class="fa fa-fill-drip"></i>1 máquina parcial
                    ({{ load_info.partial_water }} L) con:</h5>
            </div>
            <div class="card-body partial-machine">
                <div class="row">
                    {% for product in products %}
                    <div class="col-6 col-sm-3 mb-2">
                        <div class="card product-card">
                            <div class="card-body">
                                <h6 class="card-title">{{ product.product.name }}</h6>
                                <p class="card-text mb-0">
                                    {% load treatment_filters %}
                                    <span class="dose-amount">{{ product|partial_load_product:treatment }}</span>
                                    <span class="dose-unit">{{ product.total_dose_unit }}</span>
                                </p>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
        {% endif %}
        {% endwith %}
    </div>
</div>
{% endif %}

<!-- Formulario oculto para las acciones de eliminación -->
<form action="{% url 'treatment-delete' treatment.id %}" id="deleteForm" method="POST" style="display: none;">
    {% csrf_token %}
</form>

{% endblock %}

{% block extra_js %}
<script>
    // Función para finalizar tratamiento
    function finishTreatment(treatmentId) {
        Swal.fire({
            target: '#swal-container',
            title: 'Finalizar tratamiento',
            html: `
              <form id="finishSwalForm" class="text-start">
                <div class="mb-3">
                  <label for="swalFinishDate" class="form-label">Fecha de finalización</label>
                  <input type="date" class="form-control" id="swalFinishDate" required>
                </div>
              </form>
            `,
            showCancelButton: true,
            confirmButtonText: 'Finalizar',
            cancelButtonText: 'Cancelar',
            confirmButtonColor: '#198754',
            preConfirm: () => {
                const finishDate = document.getElementById('swalFinishDate').value;
                if (!finishDate) {
                    Swal.showValidationMessage('Por favor, ingresa una fecha de finalización');
                }
                return { finishDate };
            },
            heightAuto: false
        }).then((result) => {
            if (result.isConfirmed) {
                showLoading('Procesando...', 'Marcando como finalizado');
                fetch(`{% url 'treatment-finish' 0 %}`.replace('0', treatmentId), {
                    method: 'POST',
                    headers: {'X-CSRFToken': '{{ csrf_token }}'},
                    body: new URLSearchParams({ finish_date: result.value.finishDate })
                })
                .then(r => {
                    if (!r.ok) throw new Error();
                    return r.json();
                })
                .then(() => {
                    showNotification({
                        icon: 'success',
                        title: '¡Éxito!',
                        text: 'Tratamiento finalizado correctamente',
                        reload: true
                    });
                })
                .catch(() => {
                    showNotification({
                        icon: 'error',
                        title: 'Error',
                        text: 'Hubo un problema. Verifica la fecha e inténtalo de nuevo.'
                    });
                });
            }
        });
    }

    function confirmDelete() {
        showConfirm({
            text: 'Esta acción eliminará el tratamiento de forma permanente y no se podrá deshacer.',
            onConfirm: () => document.getElementById('deleteForm').submit()
        });
    }

    // Paginación de productos
    document.addEventListener('DOMContentLoaded', function() {
        const container = document.getElementById('productsContainer');
        const paginationContainer = document.getElementById('productsPagination');

        const productItems = Array.from(document.querySelectorAll('.product-item'));
        let currentPage = 1;
        // Número fijo de items por página
        const itemsPerPage = 6;

        // Función para renderizar items y paginación
        function renderItems() {
            productItems.forEach(item => item.style.display = 'none');

            // Calcular paginación
            const totalPages = Math.ceil(productItems.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, productItems.length);

            // Mostrar items de la página actual
            for (let i = startIndex; i < endIndex; i++) {
                productItems[i].style.display = '';
            }

            // Generar controles de paginación
            renderPagination(totalPages);
        }

        // Generar controles de paginación
        function renderPagination(totalPages) {
            if (totalPages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }

            let html = `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentPage - 1}" aria-label="Anterior">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
            `;

            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                html += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" data-page="${i}">${i}</a>
                    </li>
                `;
            }

            html += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentPage + 1}" aria-label="Siguiente">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            `;

            paginationContainer.innerHTML = html;

            // Agregar eventos a los enlaces de paginación
            paginationContainer.querySelectorAll('.page-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (!this.parentElement.classList.contains('disabled')) {
                        currentPage = parseInt(this.dataset.page);
                        renderItems();
                        // Scroll suave al inicio del contenedor
                        container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                });
            });
        }

        // Inicializar
        renderItems();
    });
</script>
{% endblock %}
